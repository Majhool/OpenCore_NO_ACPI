From 95ebbfb43b45af46329cc0caea48c29eee34ea15 Mon Sep 17 00:00:00 2001
From: ocbuild <ocbuild@acidanthera.local>
Date: Tue, 30 Mar 2021 23:16:22 +0100
Subject: [PATCH] ShellPkg: Devices shell command support misaligned device
 names found in some Apple firmware

---
 ShellPkg/Application/Shell/ShellProtocol.c | 24 ++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/ShellPkg/Application/Shell/ShellProtocol.c b/ShellPkg/Application/Shell/ShellProtocol.c
index 4e639fe..ac004d1 100644
--- a/ShellPkg/Application/Shell/ShellProtocol.c
+++ b/ShellPkg/Application/Shell/ShellProtocol.c
@@ -573,6 +573,22 @@ EfiShellGetDevicePathFromFilePath(
   return (DevicePathForReturn);
 }
 
+STATIC
+CHAR16 *RealignString16 (
+  CHAR16 *Source
+  )
+{
+  UINTN     Size;
+  CHAR16    NextChar;
+
+  Size = 0;
+  do {
+    NextChar = ReadUnaligned16 ((CHAR16 *) &((UINT8 *) Source)[Size]);
+    Size += 2;
+  } while (NextChar != CHAR_NULL);
+  return AllocateCopyPool (Size, Source);
+}
+
 /**
   Gets the name of the device specified by the device handle.
 
@@ -630,6 +646,7 @@ EfiShellGetDeviceName(
   EFI_HANDLE                        *ParentControllerBuffer;
   UINTN                             ParentDriverCount;
   EFI_HANDLE                        *ParentDriverBuffer;
+  BOOLEAN                           NeedsRealign;
 
   if (BestDeviceName == NULL ||
       DeviceHandle   == NULL
@@ -748,7 +765,14 @@ EfiShellGetDeviceName(
     //
     if (DeviceNameToReturn != NULL){
       ASSERT(BestDeviceName != NULL);
+      NeedsRealign = ((UINTN) DeviceNameToReturn & BIT0) != 0;
+      if (NeedsRealign) {
+        DeviceNameToReturn = RealignString16 (DeviceNameToReturn);
+      }
       StrnCatGrow(BestDeviceName, NULL, DeviceNameToReturn, 0);
+      if (NeedsRealign) {
+        FreePool (DeviceNameToReturn);
+      }
       return (EFI_SUCCESS);
     }
   }
-- 
2.27.0

